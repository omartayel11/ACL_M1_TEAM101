#!/usr/bin/env python3
"""
Comprehensive Quantitative Test for Entity Extractor
Tests the entity extractor with diverse real-world queries and validates extracted entities
"""

import sys
import time
from pathlib import Path
from typing import Dict, Any

# Add M3 directory to path
sys.path.insert(0, str(Path(__file__).parent.parent))

from components.entity_extractor import EntityExtractor


class EntityExtractorTester:
    """
    Comprehensive tester for entity extraction with accuracy metrics
    """
    
    def __init__(self):
        self.extractor = EntityExtractor(debug=False)
        self.test_cases = self._build_test_cases()
        
    def _build_test_cases(self):
        """
        Build comprehensive test cases for entity extraction
        Each test case has: query, intent, and expected entities
        """
        return [
            # ========== HotelSearch Intent (30 cases) ==========
            # City searches
            {
                "query": "Find hotels in Paris",
                "intent": "HotelSearch",
                "expected": {"city": "Paris"}
            },
            {
                "query": "Show me hotels in Tokyo",
                "intent": "HotelSearch",
                "expected": {"city": "Tokyo"}
            },
            {
                "query": "I need hotels in New York",
                "intent": "HotelSearch",
                "expected": {"city": "New York"}
            },
            {
                "query": "hotels in Dubai",
                "intent": "HotelSearch",
                "expected": {"city": "Dubai"}
            },
            {
                "query": "Looking for hotels in London",
                "intent": "HotelSearch",
                "expected": {"city": "London"}
            },
            {
                "query": "Find hotels in Cairo",
                "intent": "HotelSearch",
                "expected": {"city": "Cairo"}
            },
            {
                "query": "hotels in Sydney",
                "intent": "HotelSearch",
                "expected": {"city": "Sydney"}
            },
            
            # Country searches
            {
                "query": "Find hotels in France",
                "intent": "HotelSearch",
                "expected": {"country": "France"}
            },
            {
                "query": "Show me hotels in Japan",
                "intent": "HotelSearch",
                "expected": {"country": "Japan"}
            },
            {
                "query": "hotels in the United States",
                "intent": "HotelSearch",
                "expected": {"country": "United States"}
            },
            {
                "query": "accommodation in Egypt",
                "intent": "HotelSearch",
                "expected": {"country": "Egypt"}
            },
            {
                "query": "places to stay in Italy",
                "intent": "HotelSearch",
                "expected": {"country": "Italy"}
            },
            
            # Rating searches
            {
                "query": "Find hotels with rating above 8",
                "intent": "HotelSearch",
                "expected": {"min_rating": 8.0}
            },
            {
                "query": "Show me hotels with rating above 8.5",
                "intent": "HotelSearch",
                "expected": {"min_rating": 8.5}
            },
            {
                "query": "hotels rated 9 or higher",
                "intent": "HotelSearch",
                "expected": {"min_rating": 9.0}
            },
            {
                "query": "Find hotels with rating above 7.5",
                "intent": "HotelSearch",
                "expected": {"min_rating": 7.5}
            },
            {
                "query": "hotels with excellent ratings",
                "intent": "HotelSearch",
                "expected": {"min_rating": 8.0}
            },
            
            # Star rating searches
            {
                "query": "5-star hotels in Paris",
                "intent": "HotelSearch",
                "expected": {"city": "Paris", "star_rating": 5}
            },
            {
                "query": "Find 5 star hotels",
                "intent": "HotelSearch",
                "expected": {"star_rating": 5}
            },
            {
                "query": "I want a five-star hotel",
                "intent": "HotelSearch",
                "expected": {"star_rating": 5}
            },
            {
                "query": "Show me 4-star hotels in London",
                "intent": "HotelSearch",
                "expected": {"city": "London", "star_rating": 4}
            },
            
            # Combined criteria
            {
                "query": "Find 5-star hotels in Dubai with rating above 9",
                "intent": "HotelSearch",
                "expected": {"city": "Dubai", "star_rating": 5, "min_rating": 9.0}
            },
            {
                "query": "I need highly rated hotels in Tokyo",
                "intent": "HotelSearch",
                "expected": {"city": "Tokyo", "min_rating": 8.0}
            },
            {
                "query": "Show me top hotels in Singapore",
                "intent": "HotelSearch",
                "expected": {"city": "Singapore"}
            },
            
            # Typos
            {
                "query": "find hotels in cairo",
                "intent": "HotelSearch",
                "expected": {"city": "Cairo"}
            },
            {
                "query": "hotels in Pari",
                "intent": "HotelSearch",
                "expected": {"city": "Paris"}
            },
            {
                "query": "show me hotels in london",
                "intent": "HotelSearch",
                "expected": {"city": "London"}
            },
            
            # Natural variations
            {
                "query": "Where can I stay in Rome?",
                "intent": "HotelSearch",
                "expected": {"city": "Rome"}
            },
            {
                "query": "I'm looking for a place to stay in Barcelona",
                "intent": "HotelSearch",
                "expected": {"city": "Barcelona"}
            },
            {
                "query": "I need somewhere to stay in Berlin",
                "intent": "HotelSearch",
                "expected": {"city": "Berlin"}
            },
            
            # ========== HotelRecommendation Intent (25 cases) ==========
            # Traveler type
            {
                "query": "Best hotels for couples",
                "intent": "HotelRecommendation",
                "expected": {"traveller_type": "Couple"}
            },
            {
                "query": "Top hotels for families",
                "intent": "HotelRecommendation",
                "expected": {"traveller_type": "Family"}
            },
            {
                "query": "Recommend hotels for business travelers",
                "intent": "HotelRecommendation",
                "expected": {"traveller_type": "Business"}
            },
            {
                "query": "What are the best hotels for solo travelers?",
                "intent": "HotelRecommendation",
                "expected": {"traveller_type": "Solo"}
            },
            {
                "query": "Hotels suitable for families with kids",
                "intent": "HotelRecommendation",
                "expected": {"traveller_type": "Family"}
            },
            {
                "query": "I'm traveling for business, what hotels do you recommend?",
                "intent": "HotelRecommendation",
                "expected": {"traveller_type": "Business"}
            },
            {
                "query": "Best romantic hotels for couples",
                "intent": "HotelRecommendation",
                "expected": {"traveller_type": "Couple"}
            },
            {
                "query": "Where should a couple stay?",
                "intent": "HotelRecommendation",
                "expected": {"traveller_type": "Couple"}
            },
            {
                "query": "Recommend me hotels for a family vacation",
                "intent": "HotelRecommendation",
                "expected": {"traveller_type": "Family"}
            },
            
            # Quality scores
            {
                "query": "Hotels with high cleanliness scores",
                "intent": "HotelRecommendation",
                "expected": {"min_cleanliness": 7.5}
            },
            {
                "query": "Show me hotels with best comfort",
                "intent": "HotelRecommendation",
                "expected": {"min_comfort": 8.0}
            },
            {
                "query": "Which hotels have excellent staff?",
                "intent": "HotelRecommendation",
                "expected": {}  # Should not extract min_staff in HotelRecommendation
            },
            {
                "query": "Find hotels with great value for money",
                "intent": "HotelRecommendation",
                "expected": {"min_value": 7.5}
            },
            {
                "query": "Hotels known for their cleanliness",
                "intent": "HotelRecommendation",
                "expected": {"min_cleanliness": 7.5}
            },
            {
                "query": "Most comfortable hotels",
                "intent": "HotelRecommendation",
                "expected": {"min_comfort": 8.0}
            },
            
            # Combined
            {
                "query": "Best hotels for couples in Paris",
                "intent": "HotelRecommendation",
                "expected": {"traveller_type": "Couple", "city": "Paris"}
            },
            {
                "query": "Top family-friendly hotels in Tokyo",
                "intent": "HotelRecommendation",
                "expected": {"traveller_type": "Family", "city": "Tokyo"}
            },
            {
                "query": "Recommend business hotels in London",
                "intent": "HotelRecommendation",
                "expected": {"traveller_type": "Business", "city": "London"}
            },
            
            # With specific scores
            {
                "query": "Hotels for couples with cleanliness above 8.5",
                "intent": "HotelRecommendation",
                "expected": {"traveller_type": "Couple", "min_cleanliness": 8.5}
            },
            {
                "query": "Family hotels with comfort score above 9",
                "intent": "HotelRecommendation",
                "expected": {"traveller_type": "Family", "min_comfort": 9.0}
            },
            {
                "query": "Business hotels with good value",
                "intent": "HotelRecommendation",
                "expected": {"traveller_type": "Business", "min_value": 7.5}
            },
            
            # Edge cases
            {
                "query": "Best hotels for me and my wife",
                "intent": "HotelRecommendation",
                "expected": {"traveller_type": "Couple"}
            },
            {
                "query": "Hotels for solo traveler",
                "intent": "HotelRecommendation",
                "expected": {"traveller_type": "Solo"}
            },
            {
                "query": "I'm traveling solo, recommend hotels",
                "intent": "HotelRecommendation",
                "expected": {"traveller_type": "Solo"}
            },
            {
                "query": "Hotels with excellent cleanliness",
                "intent": "HotelRecommendation",
                "expected": {"min_cleanliness": 8.5}
            },
            
            # ========== ReviewLookup Intent (15 cases) ==========
            {
                "query": "Show me reviews for The Azure Tower",
                "intent": "ReviewLookup",
                "expected": {"hotel_name": "The Azure Tower"}
            },
            {
                "query": "What are the reviews for The Royal Compass?",
                "intent": "ReviewLookup",
                "expected": {"hotel_name": "The Royal Compass"}
            },
            {
                "query": "Reviews for L'√âtoile Palace",
                "intent": "ReviewLookup",
                "expected": {"hotel_name": "L'√âtoile Palace"}
            },
            {
                "query": "Tell me about reviews for The Golden Oasis",
                "intent": "ReviewLookup",
                "expected": {"hotel_name": "The Golden Oasis"}
            },
            {
                "query": "I want to see reviews for Marina Bay Zenith",
                "intent": "ReviewLookup",
                "expected": {"hotel_name": "Marina Bay Zenith"}
            },
            {
                "query": "Show reviews for Copacabana Lux",
                "intent": "ReviewLookup",
                "expected": {"hotel_name": "Copacabana Lux"}
            },
            {
                "query": "What do people say about The Maple Grove?",
                "intent": "ReviewLookup",
                "expected": {"hotel_name": "The Maple Grove"}
            },
            {
                "query": "Reviews for Nile Grandeur",
                "intent": "ReviewLookup",
                "expected": {"hotel_name": "Nile Grandeur"}
            },
            {
                "query": "Find reviews for The Bosphorus Inn",
                "intent": "ReviewLookup",
                "expected": {"hotel_name": "The Bosphorus Inn"}
            },
            {
                "query": "What are guests saying about The Orchid Palace?",
                "intent": "ReviewLookup",
                "expected": {"hotel_name": "The Orchid Palace"}
            },
            {
                "query": "Customer reviews for Gaudi's Retreat",
                "intent": "ReviewLookup",
                "expected": {"hotel_name": "Gaudi's Retreat"}
            },
            {
                "query": "Tell me what people think about Canal House Grand",
                "intent": "ReviewLookup",
                "expected": {"hotel_name": "Canal House Grand"}
            },
            {
                "query": "Any feedback on The Kiwi Grand?",
                "intent": "ReviewLookup",
                "expected": {"hotel_name": "The Kiwi Grand"}
            },
            {
                "query": "Reviews for Berlin Mitte Elite",
                "intent": "ReviewLookup",
                "expected": {"hotel_name": "Berlin Mitte Elite"}
            },
            {
                "query": "What do guests say about Aztec Heights?",
                "intent": "ReviewLookup",
                "expected": {"hotel_name": "Aztec Heights"}
            },
            
            # ========== LocationQuery Intent (10 cases) ==========
            {
                "query": "Hotels with best location scores",
                "intent": "LocationQuery",
                "expected": {}
            },
            {
                "query": "Which hotels have the best location?",
                "intent": "LocationQuery",
                "expected": {}
            },
            {
                "query": "Find hotels with excellent location",
                "intent": "LocationQuery",
                "expected": {}
            },
            {
                "query": "Hotels with best location in London",
                "intent": "LocationQuery",
                "expected": {"city": "London"}
            },
            {
                "query": "Find hotels with great location in Paris",
                "intent": "LocationQuery",
                "expected": {"city": "Paris"}
            },
            {
                "query": "Best located hotels in Tokyo",
                "intent": "LocationQuery",
                "expected": {"city": "Tokyo"}
            },
            {
                "query": "Hotels with top location scores in Dubai",
                "intent": "LocationQuery",
                "expected": {"city": "Dubai"}
            },
            {
                "query": "I want a hotel in a prime location",
                "intent": "LocationQuery",
                "expected": {}
            },
            {
                "query": "Show me centrally located hotels",
                "intent": "LocationQuery",
                "expected": {}
            },
            {
                "query": "Hotels with convenient locations in Singapore",
                "intent": "LocationQuery",
                "expected": {"city": "Singapore"}
            },
            
            # ========== VisaQuestion Intent (20 cases) ==========
            {
                "query": "Do I need a visa from USA to France?",
                "intent": "VisaQuestion",
                "expected": {"from_country": "United States", "to_country": "France"}
            },
            {
                "query": "Visa requirements from United Kingdom to Japan",
                "intent": "VisaQuestion",
                "expected": {"from_country": "United Kingdom", "to_country": "Japan"}
            },
            {
                "query": "Is a visa required from Germany to Egypt?",
                "intent": "VisaQuestion",
                "expected": {"from_country": "Germany", "to_country": "Egypt"}
            },
            {
                "query": "Do I need visa to travel from China to United States?",
                "intent": "VisaQuestion",
                "expected": {"from_country": "China", "to_country": "United States"}
            },
            {
                "query": "Visa requirements from India to United Kingdom",
                "intent": "VisaQuestion",
                "expected": {"from_country": "India", "to_country": "United Kingdom"}
            },
            {
                "query": "Check visa from Canada to Australia",
                "intent": "VisaQuestion",
                "expected": {"from_country": "Canada", "to_country": "Australia"}
            },
            {
                "query": "Do citizens of Brazil need visa for Singapore?",
                "intent": "VisaQuestion",
                "expected": {"from_country": "Brazil", "to_country": "Singapore"}
            },
            {
                "query": "Is visa needed from Russia to France?",
                "intent": "VisaQuestion",
                "expected": {"from_country": "Russia", "to_country": "France"}
            },
            {
                "query": "Visa requirements from Egypt to Germany",
                "intent": "VisaQuestion",
                "expected": {"from_country": "Egypt", "to_country": "Germany"}
            },
            {
                "query": "Do I need a visa from South Africa to Italy?",
                "intent": "VisaQuestion",
                "expected": {"from_country": "South Africa", "to_country": "Italy"}
            },
            {
                "query": "Can I travel from USA to Japan without a visa?",
                "intent": "VisaQuestion",
                "expected": {"from_country": "United States", "to_country": "Japan"}
            },
            {
                "query": "What are the visa requirements from Mexico to Spain?",
                "intent": "VisaQuestion",
                "expected": {"from_country": "Mexico", "to_country": "Spain"}
            },
            {
                "query": "I'm from Thailand, do I need visa for United Arab Emirates?",
                "intent": "VisaQuestion",
                "expected": {"from_country": "Thailand", "to_country": "United Arab Emirates"}
            },
            {
                "query": "Traveling from South Korea to Canada, need visa?",
                "intent": "VisaQuestion",
                "expected": {"from_country": "South Korea", "to_country": "Canada"}
            },
            {
                "query": "Check if I need travel documents from Australia to United Kingdom",
                "intent": "VisaQuestion",
                "expected": {"from_country": "Australia", "to_country": "United Kingdom"}
            },
            {
                "query": "Visa from France to Italy",
                "intent": "VisaQuestion",
                "expected": {"from_country": "France", "to_country": "Italy"}
            },
            {
                "query": "Travel document requirements from United States to Mexico",
                "intent": "VisaQuestion",
                "expected": {"from_country": "United States", "to_country": "Mexico"}
            },
            {
                "query": "Do I need visa from Turkey to Germany?",
                "intent": "VisaQuestion",
                "expected": {"from_country": "Turkey", "to_country": "Germany"}
            },
            {
                "query": "Visa requirements from Argentina to Spain",
                "intent": "VisaQuestion",
                "expected": {"from_country": "Argentina", "to_country": "Spain"}
            },
            {
                "query": "Is visa needed from New Zealand to Australia?",
                "intent": "VisaQuestion",
                "expected": {"from_country": "New Zealand", "to_country": "Australia"}
            },
            
            # ========== AmenityFilter Intent (25 cases) ==========
            # Cleanliness
            {
                "query": "Hotels with high cleanliness",
                "intent": "AmenityFilter",
                "expected": {"min_cleanliness": 7.5}
            },
            {
                "query": "Find hotels with cleanliness score above 9",
                "intent": "AmenityFilter",
                "expected": {"min_cleanliness": 9.0}
            },
            {
                "query": "I need hotels with excellent cleanliness",
                "intent": "AmenityFilter",
                "expected": {"min_cleanliness": 8.5}
            },
            {
                "query": "Show me the cleanest hotels",
                "intent": "AmenityFilter",
                "expected": {"min_cleanliness": 8.0}
            },
            {
                "query": "Hotels with cleanliness above 8.5",
                "intent": "AmenityFilter",
                "expected": {"min_cleanliness": 8.5}
            },
            
            # Comfort
            {
                "query": "Hotels with high comfort score",
                "intent": "AmenityFilter",
                "expected": {"min_comfort": 7.5}
            },
            {
                "query": "Find comfortable hotels",
                "intent": "AmenityFilter",
                "expected": {"min_comfort": 7.5}
            },
            {
                "query": "I want hotels with excellent comfort",
                "intent": "AmenityFilter",
                "expected": {"min_comfort": 8.5}
            },
            {
                "query": "Show me hotels with comfort above 9",
                "intent": "AmenityFilter",
                "expected": {"min_comfort": 9.0}
            },
            {
                "query": "Most comfortable hotels available",
                "intent": "AmenityFilter",
                "expected": {"min_comfort": 8.0}
            },
            
            # Value for money
            {
                "query": "Good value for money",
                "intent": "AmenityFilter",
                "expected": {"min_value": 7.5}
            },
            {
                "query": "Hotels with best value for money",
                "intent": "AmenityFilter",
                "expected": {"min_value": 8.0}
            },
            {
                "query": "I need hotels with high value",
                "intent": "AmenityFilter",
                "expected": {"min_value": 7.5}
            },
            {
                "query": "Find hotels with value for money above 8.5",
                "intent": "AmenityFilter",
                "expected": {"min_value": 8.5}
            },
            {
                "query": "Hotels with excellent value for money",
                "intent": "AmenityFilter",
                "expected": {"min_value": 8.5}
            },
            
            # Staff
            {
                "query": "Hotels with excellent staff",
                "intent": "AmenityFilter",
                "expected": {"min_staff": 8.5}
            },
            {
                "query": "Find hotels with great staff service",
                "intent": "AmenityFilter",
                "expected": {"min_staff": 7.5}
            },
            {
                "query": "I need hotels with high staff scores",
                "intent": "AmenityFilter",
                "expected": {"min_staff": 7.5}
            },
            {
                "query": "Show me hotels with staff rating above 9",
                "intent": "AmenityFilter",
                "expected": {"min_staff": 9.0}
            },
            {
                "query": "Hotels with best staff ratings",
                "intent": "AmenityFilter",
                "expected": {"min_staff": 8.0}
            },
            
            # Combined
            {
                "query": "Hotels with high cleanliness and comfort",
                "intent": "AmenityFilter",
                "expected": {"min_cleanliness": 7.5, "min_comfort": 7.5}
            },
            {
                "query": "Find hotels with good value and excellent staff",
                "intent": "AmenityFilter",
                "expected": {"min_value": 7.5, "min_staff": 8.5}
            },
            {
                "query": "I need clean hotels with comfortable rooms",
                "intent": "AmenityFilter",
                "expected": {"min_cleanliness": 7.5, "min_comfort": 7.5}
            },
            {
                "query": "Show me hotels with cleanliness above 9 and comfort above 8.5",
                "intent": "AmenityFilter",
                "expected": {"min_cleanliness": 9.0, "min_comfort": 8.5}
            },
            {
                "query": "Hotels with excellent staff and great value",
                "intent": "AmenityFilter",
                "expected": {"min_staff": 8.5, "min_value": 7.5}
            },
            
            # ========== GeneralQuestionAnswering Intent (10 cases) ==========
            {
                "query": "Tell me about The Azure Tower",
                "intent": "GeneralQuestionAnswering",
                "expected": {"hotel_name": "The Azure Tower"}
            },
            {
                "query": "Give me information about The Royal Compass",
                "intent": "GeneralQuestionAnswering",
                "expected": {"hotel_name": "The Royal Compass"}
            },
            {
                "query": "Describe The Golden Oasis",
                "intent": "GeneralQuestionAnswering",
                "expected": {"hotel_name": "The Golden Oasis"}
            },
            {
                "query": "What are the facilities at Marina Bay Zenith?",
                "intent": "GeneralQuestionAnswering",
                "expected": {"hotel_name": "Marina Bay Zenith"}
            },
            {
                "query": "Tell me everything about Copacabana Lux",
                "intent": "GeneralQuestionAnswering",
                "expected": {"hotel_name": "Copacabana Lux"}
            },
            {
                "query": "Information about The Maple Grove hotel",
                "intent": "GeneralQuestionAnswering",
                "expected": {"hotel_name": "The Maple Grove"}
            },
            {
                "query": "What can you tell me about Nile Grandeur?",
                "intent": "GeneralQuestionAnswering",
                "expected": {"hotel_name": "Nile Grandeur"}
            },
            {
                "query": "Details about The Bosphorus Inn",
                "intent": "GeneralQuestionAnswering",
                "expected": {"hotel_name": "The Bosphorus Inn"}
            },
            {
                "query": "I want comprehensive information about The Orchid Palace",
                "intent": "GeneralQuestionAnswering",
                "expected": {"hotel_name": "The Orchid Palace"}
            },
            {
                "query": "What do you know about hotels in Paris?",
                "intent": "GeneralQuestionAnswering",
                "expected": {"city": "Paris"}
            },
        ]
    
    def _entities_match(self, extracted: Dict[str, Any], expected: Dict[str, Any]) -> bool:
        """
        Check if extracted entities match expected entities
        
        Args:
            extracted: Extracted entities from entity extractor
            expected: Expected entities
            
        Returns:
            True if all expected entities are present and correct
        """
        for key, value in expected.items():
            if key not in extracted:
                return False
            
            extracted_value = extracted[key]
            
            # Handle numeric comparison with tolerance
            if isinstance(value, (int, float)) and isinstance(extracted_value, (int, float)):
                if abs(float(extracted_value) - float(value)) > 0.01:
                    return False
            # Handle string comparison (case-insensitive)
            elif isinstance(value, str) and isinstance(extracted_value, str):
                if value.lower().strip() != extracted_value.lower().strip():
                    return False
            # Exact match for other types
            elif extracted_value != value:
                return False
        
        return True
    
    def run_tests(self, verbose=False):
        """
        Run all test cases and calculate accuracy metrics
        
        Args:
            verbose: If True, print detailed results for each test case
        
        Returns:
            dict: Test results with accuracy metrics
        """
        results = {
            "total": len(self.test_cases),
            "correct": 0,
            "incorrect": 0,
            "by_intent": {},
            "failures": []
        }
        
        # Initialize per-intent tracking
        intents = set(tc["intent"] for tc in self.test_cases)
        for intent in intents:
            results["by_intent"][intent] = {
                "total": 0,
                "correct": 0,
                "incorrect": 0,
                "accuracy": 0.0
            }
        
        print("=" * 80)
        print("ENTITY EXTRACTOR QUANTITATIVE TEST")
        print("=" * 80)
        print(f"Total test cases: {results['total']}")
        print("=" * 80)
        print()
        
        # Run each test case
        for i, test_case in enumerate(self.test_cases, 1):
            query = test_case["query"]
            intent = test_case["intent"]
            expected = test_case["expected"]
            
            # Extract entities
            extracted = self.extractor.extract(query, intent)
            
            # Check if correct
            is_correct = self._entities_match(extracted, expected)
            
            # Update results
            if is_correct:
                results["correct"] += 1
                results["by_intent"][intent]["correct"] += 1
            else:
                results["incorrect"] += 1
                results["by_intent"][intent]["incorrect"] += 1
                results["failures"].append({
                    "query": query,
                    "intent": intent,
                    "expected": expected,
                    "extracted": extracted
                })
            
            results["by_intent"][intent]["total"] += 1
            
            # Print if verbose or incorrect
            if verbose or not is_correct:
                status = "‚úÖ PASS" if is_correct else "‚ùå FAIL"
                print(f"[{i}/{results['total']}] {status}")
                print(f"  Query: \"{query}\"")
                print(f"  Intent: {intent}")
                print(f"  Expected: {expected}")
                print(f"  Extracted: {extracted}")
                if not is_correct:
                    print(f"  ‚ö†Ô∏è  MISMATCH")
                print()
            
            # Wait 10 seconds between LLM calls to avoid API quota limits
            if i < len(self.test_cases):
                time.sleep(10)
        
        # Calculate per-intent accuracy
        for intent in results["by_intent"]:
            intent_data = results["by_intent"][intent]
            if intent_data["total"] > 0:
                intent_data["accuracy"] = (intent_data["correct"] / intent_data["total"]) * 100
        
        # Calculate overall accuracy
        results["accuracy"] = (results["correct"] / results["total"]) * 100
        
        return results
    
    def print_results(self, results):
        """
        Print comprehensive test results with accuracy metrics
        
        Args:
            results: Test results dictionary from run_tests()
        """
        print()
        print("=" * 80)
        print("TEST RESULTS SUMMARY")
        print("=" * 80)
        print()
        
        # Overall accuracy
        print(f"üìä OVERALL ACCURACY: {results['accuracy']:.2f}%")
        print(f"   ‚úÖ Correct: {results['correct']}/{results['total']}")
        print(f"   ‚ùå Incorrect: {results['incorrect']}/{results['total']}")
        print()
        
        # Per-intent accuracy
        print("=" * 80)
        print("ACCURACY BY INTENT")
        print("=" * 80)
        print()
        
        # Sort intents by total count (descending)
        sorted_intents = sorted(
            results["by_intent"].items(),
            key=lambda x: x[1]["total"],
            reverse=True
        )
        
        for intent, data in sorted_intents:
            if data["total"] > 0:
                accuracy_bar = "‚ñà" * int(data["accuracy"] / 5) + "‚ñë" * (20 - int(data["accuracy"] / 5))
                print(f"{intent:30s} {accuracy_bar} {data['accuracy']:6.2f}%")
                print(f"{'':30s} ({data['correct']}/{data['total']} correct)")
                print()
        
        # Failures
        if results["failures"]:
            print("=" * 80)
            print("FAILED TEST CASES")
            print("=" * 80)
            print()
            
            for i, failure in enumerate(results["failures"], 1):
                print(f"‚ùå Failure #{i}")
                print(f"   Query: \"{failure['query']}\"")
                print(f"   Intent: {failure['intent']}")
                print(f"   Expected: {failure['expected']}")
                print(f"   Extracted: {failure['extracted']}")
                print()
        else:
            print("=" * 80)
            print("üéâ ALL TESTS PASSED!")
            print("=" * 80)
            print()


def main():
    """
    Main entry point for quantitative testing
    """
    import argparse
    
    parser = argparse.ArgumentParser(description="Quantitative test for entity extractor")
    parser.add_argument(
        "-v", "--verbose",
        action="store_true",
        help="Print detailed results for each test case (default: only failures)"
    )
    parser.add_argument(
        "-o", "--output",
        type=str,
        default="entity_extractor_results.txt",
        help="Output file for results (default: entity_extractor_results.txt)"
    )
    
    args = parser.parse_args()
    
    # Redirect stdout to file
    original_stdout = sys.stdout
    with open(args.output, 'w', encoding='utf-8') as f:
        sys.stdout = f
        
        # Create tester and run tests
        tester = EntityExtractorTester()
        results = tester.run_tests(verbose=args.verbose)
        
        # Print results
        tester.print_results(results)
    
    # Restore stdout
    sys.stdout = original_stdout
    
    # Print completion message to console
    print(f"‚úÖ Entity extractor test completed!")
    print(f"üìÑ Results saved to: {args.output}")
    print(f"üìä Overall accuracy: {results['accuracy']:.2f}%")
    
    # Exit with appropriate code
    exit_code = 0 if results["accuracy"] == 100.0 else 1
    sys.exit(exit_code)


if __name__ == "__main__":
    main()
